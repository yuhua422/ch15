<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒä¸‹çŸ­èªæŒ‘æˆ°è³½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        [hidden] { display: none !important; }
        .animate-pop-in { animation: pop-in 0.2s ease-out; }
        @keyframes pop-in { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .word-btn:active { transform: scale(0.95); }
        .answer-slot {
            min-width: 60px;
            border-bottom: 3px solid #6366f1;
            margin: 0 4px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">

    <!-- è¨­å®šç•«é¢ -->
    <div id="setup-screen" class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md border border-slate-200">
        <div class="text-center mb-8">
            <div class="inline-block p-4 bg-indigo-50 rounded-full mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
            </div>
            <h1 class="text-3xl font-black text-slate-800">äºŒä¸‹çŸ­èªæŒ‘æˆ°è³½</h1>
            <p class="text-slate-500 mt-2">1 - 12 èª²é‡çµ„ç·´ç¿’</p>
        </div>
        
        <div class="space-y-6">
            <div>
                <label class="block text-slate-700 font-bold mb-3 text-sm uppercase tracking-wider">é¸æ“‡èª²æ¬¡</label>
                <select id="lesson-select" class="w-full p-4 border border-slate-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-indigo-100 text-lg bg-slate-50 transition-all appearance-none cursor-pointer">
                    <option value="">è«‹é»æ“Šé¸æ“‡...</option>
                </select>
            </div>

            <div class="bg-indigo-600 p-4 rounded-2xl text-white shadow-lg shadow-indigo-200">
                <p class="text-sm font-medium leading-relaxed">
                    ğŸ’¡ æŒ‘æˆ°èªªæ˜ï¼šè§€å¯Ÿçµæ§‹æç¤ºèˆ‡ä¾‹å¥ï¼Œé»æ“Šè©èªæŒ‰éˆ•æ’åˆ—å‡ºæ­£ç¢ºçš„çµ„åˆã€‚
                </p>
            </div>

            <button id="start-btn" disabled class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-5 rounded-2xl shadow-lg transition-all transform hover:-translate-y-1 disabled:opacity-30 disabled:hover:translate-y-0 disabled:cursor-not-allowed text-xl">
                é–‹å§‹æŒ‘æˆ°
            </button>
        </div>
    </div>

    <!-- ç·´ç¿’ç•«é¢ -->
    <div id="practice-screen" hidden class="bg-white p-4 sm:p-8 rounded-3xl shadow-2xl w-full max-w-3xl border border-slate-100 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-indigo-600"></div>

        <div class="flex justify-between items-center mb-6 pt-4">
            <div class="flex flex-col">
                <span id="lesson-title" class="text-slate-400 text-xs font-bold tracking-widest uppercase mb-1">æ­£åœ¨é€²è¡Œ</span>
                <div class="text-indigo-600 font-black text-xl" id="progress-tag">é€²åº¦ 1 / 4</div>
            </div>
            <div class="text-right">
                <span class="text-slate-400 text-xs font-bold tracking-widest uppercase mb-1 block">ç•¶å‰åˆ†æ•¸</span>
                <span class="text-2xl font-black text-slate-800" id="current-score-display">0</span>
            </div>
        </div>

        <!-- æ ¸å¿ƒç·´ç¿’å€ -->
        <div class="mb-10 space-y-4">
            <div class="flex items-start gap-3">
                <div class="w-1 h-12 bg-indigo-600 rounded-full mt-1"></div>
                <div class="space-y-2">
                    <p id="example-sentence" class="text-xl font-bold text-indigo-600">ä¾‹å¥ï¼šæ­£åœ¨è¼‰å…¥...</p>
                    <h2 id="structure-hint" class="text-xl font-bold text-slate-700 leading-tight">çµæ§‹ï¼š...</h2>
                </div>
            </div>
            
            <div id="answer-container" class="bg-slate-50 border-2 border-slate-100 rounded-3xl p-8 min-h-[160px] flex flex-wrap justify-center items-center gap-y-6">
                <div id="answer-zone" class="flex flex-wrap justify-center items-center gap-x-1 gap-y-4">
                </div>
            </div>
        </div>

        <!-- è©èªé¸æ“‡å€ -->
        <div class="mb-8">
            <p class="text-center text-slate-400 text-sm font-bold mb-4 tracking-widest uppercase">é»é¸è©èª</p>
            <div id="word-pool" class="flex flex-wrap justify-center gap-3">
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="flex flex-col sm:flex-row gap-4">
            <button id="clear-btn" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-4 rounded-2xl transition-all flex items-center justify-center gap-2">
                å…¨éƒ¨é‡å¡«
            </button>
            <button id="check-btn" class="flex-[2] bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-xl shadow-indigo-100 transition-all flex items-center justify-center gap-2 text-lg">
                ç¢ºèªé€å‡º
            </button>
        </div>
    </div>

    <!-- çµæœç•«é¢ -->
    <div id="results-screen" hidden class="bg-white p-12 rounded-3xl shadow-2xl w-full max-w-md text-center animate-pop-in border border-slate-100">
        <div id="score-emoji" class="text-8xl mb-6 drop-shadow-lg">ğŸŒŸ</div>
        <h2 class="text-3xl font-black text-slate-800 mb-2">æŒ‘æˆ°å®Œæˆï¼</h2>
        <p id="result-comment" class="text-slate-500 font-medium mb-10">ä½ çš„è¡¨ç¾éå¸¸å‡ºè‰²ï¼</p>

        <div class="bg-slate-50 rounded-3xl p-8 mb-10 border border-slate-100">
            <div class="text-6xl font-black text-indigo-600 mb-1" id="final-score-text">0</div>
            <div class="text-slate-400 font-bold tracking-widest text-sm uppercase">æœ€çµ‚å¾—åˆ†</div>
        </div>

        <div class="grid grid-cols-1 gap-4">
            <button id="retry-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-5 rounded-2xl shadow-lg transition-all transform hover:scale-[1.02]">
                å†æŒ‘æˆ°ä¸€æ¬¡
            </button>
            <button id="home-btn" class="bg-slate-100 hover:bg-slate-200 text-slate-500 font-bold py-4 rounded-2xl transition-all">
                è¿”å›ä¸»é¸å–®
            </button>
        </div>
    </div>

    <script>
        const lessonsData = [
            {
                id: 1, title: "ç¬¬ä¸€èª²ï¼šç¨®å­æ—…è¡ŒçœŸå¥‡å¦™",
                items: [
                    { struct: "åè©(èª°)+ç–Šå­—å‰¯è©+å‹•è©", example: "è»Šå­å¿«å¿«è·‘", chunks: ["é¢¨å…’", "è¼•è¼•", "å¹"] },
                    { struct: "åè©(èª°)+ç–Šå­—å‰¯è©+å‹•è©", example: "é¢¨å…’è¼•è¼•å¹", chunks: ["è¸ç‰›", "æ…¢æ…¢", "çˆ¬"] },
                    { struct: "åè©(èª°çš„ä»€éº¼)+å½¢å®¹è©+åˆ+å½¢å®¹è©", example: "é¬¼é‡è‰çš„ç¨®å­åˆºåˆå°–", chunks: ["å¦¹å¦¹çš„", "é ­é«®", "é»‘", "åˆ", "é•·"] },
                    { struct: "åè©(èª°çš„ä»€éº¼)+å½¢å®¹è©+åˆ+å½¢å®¹è©", example: "å¦¹å¦¹çš„é ­é«®é»‘åˆé•·", chunks: ["å“¥å“¥çš„", "å­—å…¸", "åš", "åˆ", "é‡"] }
                ]
            },
            {
                id: 2, title: "ç¬¬äºŒèª²ï¼šå°æ°´æ»´æ„›ä¸Šæ¢éšª",
                items: [
                    { struct: "æ›´+å½¢å®¹è©+çš„+åè©", example: "æ›´è±å¯Œçš„è‰²å½©", chunks: ["æ›´", "ç¾éº—", "çš„", "é¢¨æ™¯"] },
                    { struct: "æ›´+å½¢å®¹è©+çš„+åè©", example: "æ›´ç¾éº—çš„é¢¨æ™¯", chunks: ["æ›´", "å¥½ç©", "çš„", "éŠæˆ²"] },
                    { struct: "åè©+åƒ+åè©+ä¸€æ¨£+å‹•è©", example: "é›¨æ»´åƒçç ä¸€æ¨£æ»¾ä¾†æ»¾å»", chunks: ["å¼Ÿå¼Ÿ", "åƒ", "å°ç‹—", "ä¸€æ¨£", "è·‘ä¾†è·‘å»"] },
                    { struct: "åè©+åƒ+åè©+ä¸€æ¨£+å‹•è©", example: "å¼Ÿå¼Ÿåƒå°ç‹—ä¸€æ¨£è·‘ä¾†è·‘å»", chunks: ["å¦¹å¦¹", "åƒ", "é’è›™", "ä¸€æ¨£", "è·³ä¾†è·³å»"] }
                ]
            },
            {
                id: 3, title: "ç¬¬ä¸‰èª²ï¼šç´«æ–‘è¶å‘åŒ—é£›",
                items: [
                    { struct: "ä¸€+ç–Šå­—é‡è©+å‹•è©+åè©(åœ°æ–¹)", example: "ä¸€ç¾¤ç¾¤é£›éå±±è°·", chunks: ["ä¸€éš»éš»", "é£›ä¸Š", "å¤©ç©º"] },
                    { struct: "ä¸€+ç–Šå­—é‡è©+å‹•è©+åè©(åœ°æ–¹)", example: "ä¸€éš»éš»é£›ä¸Šå¤©ç©º", chunks: ["ä¸€æœµæœµ", "é–‹åœ¨", "è·¯é‚Š"] },
                    { struct: "é€™äº›éƒ½æ˜¯+åè©(èª°)+çš„+åè©", example: "é€™äº›éƒ½æ˜¯å¤§è‡ªç„¶çš„ç¦®ç‰©", chunks: ["é€™äº›éƒ½æ˜¯", "å¦¹å¦¹çš„", "ç©å…·"] },
                    { struct: "é€™äº›éƒ½æ˜¯+åè©(èª°)+çš„+åè©", example: "é€™äº›éƒ½æ˜¯å¦¹å¦¹çš„ç©å…·", chunks: ["é€™äº›éƒ½æ˜¯", "ä»–çš„", "ä½œå“"] }
                ]
            },
            {
                id: 4, title: "ç¬¬å››èª²ï¼šä¸€å ´é›¨",
                items: [
                    { struct: "ä¸+å½¢å®¹è©+ä¹Ÿä¸+ç›¸åå½¢å®¹è©", example: "ä¸å¤šä¹Ÿä¸å°‘", chunks: ["ä¸", "å†·", "ä¹Ÿ", "ä¸", "ç†±"] },
                    { struct: "ä¸+å½¢å®¹è©+ä¹Ÿä¸+ç›¸åå½¢å®¹è©", example: "ä¸å†·ä¹Ÿä¸ç†±", chunks: ["ä¸", "å¿«", "ä¹Ÿ", "ä¸", "æ…¢"] },
                    { struct: "åè©+èƒ½+å‹•è©(ç›®çš„)", example: "ä¹¾æ¯çš„å¤§åœ°èƒ½æ»‹æ½¤", chunks: ["ç–²å€¦çš„", "åª½åª½", "èƒ½", "ä¼‘æ¯"] },
                    { struct: "åè©+èƒ½+å‹•è©(ç›®çš„)", example: "ç–²å€¦çš„åª½åª½èƒ½ä¼‘æ¯", chunks: ["è°æ˜çš„", "ç« é­š", "èƒ½", "æ€è€ƒ"] }
                ]
            },
            {
                id: 5, title: "ç¬¬äº”èª²ï¼šå¤§è‡ªç„¶çš„é›•åˆ»å®¶",
                items: [
                    { struct: "åè©(èª°)+åœ¨+åè©(å“ªè£¡)+å‹•è©", example: "æ°´åœ¨å²©çŸ³æ²–åˆ·", chunks: ["é¢¨", "åœ¨", "å¤§åœ°", "åˆ»ç•«"] },
                    { struct: "åè©(èª°)+åœ¨+åè©(å“ªè£¡)+å‹•è©", example: "é¢¨åœ¨å¤§åœ°åˆ»ç•«", chunks: ["æ°´", "åœ¨", "å±±è°·", "å”±æ­Œ"] },
                    { struct: "å½¢å®¹è©+çš„+åè©(ç‰©)+åè©(ç‰©)", example: "æœ‰è¶£çš„åœ–ç•«æ•…äº‹", chunks: ["ç¥å¥‡çš„", "é¢¨åˆ€", "æ°´åŠ"] },
                    { struct: "å½¢å®¹è©+çš„+åè©(ç‰©)+åè©(ç‰©)", example: "ç¥å¥‡çš„é¢¨åˆ€æ°´åŠ", chunks: ["ç¾å‘³çš„", "æ¼¢å ¡", "è–¯æ¢"] }
                ]
            },
            {
                id: 6, title: "ç¬¬å…­èª²ï¼šæœ€å¾Œçš„ä¸€æ£µæ¨¹",
                items: [
                    { struct: "å‹•è©+è‘—+å½¢å®¹è©+çš„+åè©", example: "çœ‹è‘—ç‡¦çˆ›çš„é™½å…‰", chunks: ["å¹è‘—", "æ¶¼çˆ½", "çš„", "å¾®é¢¨"] },
                    { struct: "å‹•è©+è‘—+å½¢å®¹è©+çš„+åè©", example: "å¹è‘—æ¶¼çˆ½çš„å¾®é¢¨", chunks: ["å”±è‘—", "å‹•è½", "çš„", "æ­Œæ›²"] },
                    { struct: "åè©(èª°)+å‹•è©+åœ¨+åè©(å“ªè£¡)", example: "çŒ´å­çˆ¬åœ¨æ¨¹å¹¹", chunks: ["å°é³¥", "åœ", "åœ¨", "æé ­"] },
                    { struct: "åè©(èª°)+å‹•è©+åœ¨+åè©(å“ªè£¡)", example: "å°é³¥åœåœ¨æé ­", chunks: ["æ¾é¼ ", "èº²", "åœ¨", "æ¨¹æ´"] }
                ]
            },
            {
                id: 7, title: "ç¬¬ä¸ƒèª²ï¼šèœ˜è››æ•‘è›‹",
                items: [
                    { struct: "ä¸€+é‡è©+å½¢å®¹è©+çš„+åè©", example: "ä¸€å€‹ç‰¹åˆ¥çš„ç¦®ç‰©", chunks: ["ä¸€", "é“", "ç´°é•·", "çš„", "è£‚ç—•"] },
                    { struct: "ä¸€+é‡è©+å½¢å®¹è©+çš„+åè©", example: "ä¸€é“ç´°é•·çš„è£‚ç—•", chunks: ["ä¸€", "å¡Š", "ç¾å‘³", "çš„", "è›‹ç³•"] },
                    { struct: "åè©+å‹•è©+äº†+ä¸€+é‡è©+åè©", example: "çª—æˆ¶ç ´äº†ä¸€å€‹å¤§æ´", chunks: ["å¤©ç©º", "ç ´", "äº†", "ä¸€å€‹", "å¤§æ´"] },
                    { struct: "åè©+å‹•è©+äº†+ä¸€+é‡è©+åè©", example: "å¤©ç©ºç ´äº†ä¸€å€‹å¤§æ´", chunks: ["åœ°ä¸Š", "é–‹", "äº†", "ä¸€æœµ", "å°èŠ±"] }
                ]
            },
            {
                id: 8, title: "ç¬¬å…«èª²ï¼šåœ‹ç‹èˆ‡æ˜ç ",
                items: [
                    { struct: "å‹•è©+äº†+æ•¸é‡+é‡è©+å½¢å®¹è©+çš„+åè©", example: "æ¡äº†å¹¾æœµæ¼‚äº®çš„é®®èŠ±", chunks: ["æ›äº†", "å¹¾é¡†", "é–ƒäº®", "çš„", "æ˜ç "] },
                    { struct: "å‹•è©+äº†+æ•¸é‡+é‡è©+å½¢å®¹è©+çš„+åè©", example: "æ›äº†å¹¾é¡†é–ƒäº®çš„æ˜ç ", chunks: ["è²·äº†", "å¹¾æœ¬", "æœ‰è¶£", "çš„", "æ•…äº‹æ›¸"] },
                    { struct: "åè©+æŠŠ+åè©+å‹•è©+åœ¨+åè©(åœ°æ–¹)", example: "æˆ‘æŠŠæ›¸æœ¬æ”¾åœ¨æ›¸æ¶ä¸Š", chunks: ["åœ‹ç‹", "æŠŠ", "æ˜ç ", "é‘²åœ¨", "ç‹å† ä¸Š"] },
                    { struct: "åè©+æŠŠ+åè©+å‹•è©+åœ¨+åè©(åœ°æ–¹)", example: "åœ‹ç‹æŠŠæ˜ç é‘²åœ¨ç‹å† ä¸Š", chunks: ["å§å§", "æŠŠ", "è²¼ç´™", "é»åœ¨", "ç­†è¨˜æœ¬ä¸Š"] }
                ]
            },
            {
                id: 9, title: "ç¬¬ä¹èª²ï¼šæˆåŠŸä¸å¿…åœ¨æˆ‘",
                items: [
                    { struct: "ç–Šå­—å‹•è©+ä¸€+ç–Šå­—å‹•è©", example: "è½ä¸€è½", chunks: ["è", "ä¸€", "è"] },
                    { struct: "ç–Šå­—å‹•è©+ä¸€+ç–Šå­—å‹•è©", example: "èä¸€è", chunks: ["çœ‹", "ä¸€", "çœ‹"] },
                    { struct: "åè©+é›–ç„¶+å½¢å®¹è©ï¼Œå»+å½¢å®¹è©", example: "å“¥å“¥é›–ç„¶ç˜¦å°ï¼Œå»å¾ˆæœ‰åŠ›", chunks: ["å°è‰", "é›–ç„¶", "çŸ®å°", "ï¼Œå»", "å¾ˆå …å¼·"] },
                    { struct: "åè©+é›–ç„¶+å½¢å®¹è©ï¼Œå»+å½¢å®¹è©", example: "å°è‰é›–ç„¶çŸ®å°ï¼Œå»å¾ˆå …å¼·", chunks: ["å¤©æ°£", "é›–ç„¶", "å¯’å†·", "ï¼Œå»", "å¾ˆæ™´æœ—"] }
                ]
            },
            {
                id: 10, title: "ç¬¬åèª²ï¼šæˆ‘æ„›çœ‹æ›¸",
                items: [
                    { struct: "ç–Šå­—å½¢å®¹è©+çš„+åè©", example: "ç´…é€šé€šçš„è‡‰è›‹", chunks: ["å»£å¤§å¤§", "çš„", "ä¸–ç•Œ"] },
                    { struct: "ç–Šå­—å½¢å®¹è©+çš„+åè©", example: "å»£å¤§å¤§çš„ä¸–ç•Œ", chunks: ["é•·é•·", "çš„", "å°è·¯"] },
                    { struct: "åè©+è®“+åè©+å‹•è©+äº†", example: "å­¸ç¿’è®“å¤§è…¦éˆæ´»äº†", chunks: ["é–±è®€", "è®“", "ç”Ÿæ´»", "è±å¯Œ", "äº†"] },
                    { struct: "åè©+è®“+åè©+å‹•è©+äº†", example: "é–±è®€è®“ç”Ÿæ´»è±å¯Œäº†", chunks: ["é‹å‹•", "è®“", "èº«é«”", "å¥åº·", "äº†"] }
                ]
            },
            {
                id: 11, title: "ç¬¬åä¸€èª²ï¼šå°é’è›™æƒ³é•·å¤§",
                items: [
                    { struct: "ç–Šå­—å½¢å®¹è©+ç–Šå­—å½¢å®¹è©+çš„+å‹•è©", example: "ä¹¾ä¹¾æ·¨æ·¨çš„æ‰“æƒ", chunks: ["èˆ’èˆ’æœæœ", "çš„", "ç¡è¦º"] },
                    { struct: "ç–Šå­—å½¢å®¹è©+ç–Šå­—å½¢å®¹è©+çš„+å‹•è©", example: "èˆ’èˆ’æœæœçš„ç¡è¦º", chunks: ["é–‹é–‹å¿ƒå¿ƒ", "çš„", "ç©è€"] },
                    { struct: "åè©+ä¸€é»ä¹Ÿä¸+å½¢å®¹è©", example: "ä»–ä¸€é»ä¹Ÿä¸é¤“", chunks: ["ä»–", "ä¸€é»ä¹Ÿä¸", "ç´¯"] },
                    { struct: "åè©+ä¸€é»ä¹Ÿä¸+å½¢å®¹è©", example: "ä»–ä¸€é»ä¹Ÿä¸ç´¯", chunks: ["é€™è£¡", "ä¸€é»ä¹Ÿä¸", "é "] }
                ]
            },
            {
                id: 12, title: "ç¬¬åäºŒèª²ï¼šå°ç´™èˆ¹",
                items: [
                    { struct: "å‹•è©+åè©+åˆ°+åè©(å“ªè£¡)", example: "é€ç¦®ç‰©åˆ°å®¶è£¡", chunks: ["æ‘º", "ç´™èˆ¹", "åˆ°", "æµ·é‚Š"] },
                    { struct: "å‹•è©+åè©+åˆ°+åè©(å“ªè£¡)", example: "æ‘ºç´™èˆ¹åˆ°æµ·é‚Š", chunks: ["å¯«", "å¡ç‰‡", "åˆ°", "é æ–¹"] },
                    { struct: "åè©+åœ¨+åè©(åœ°æ–¹)+å‹•è©", example: "çˆ¸çˆ¸åœ¨å…¬å¸ä¸Šç­", chunks: ["æˆ‘å€‘", "åœ¨", "è‰åœ°", "è·‘æ­¥"] },
                    { struct: "åè©+åœ¨+åè©(åœ°æ–¹)+å‹•è©", example: "æˆ‘å€‘åœ¨è‰åœ°è·‘æ­¥", chunks: ["é­šå…’", "åœ¨", "æ°´è£¡", "æ¸¸æ°´"] }
                ]
            }
        ];

        let state = {
            currentLesson: null,
            questions: [],
            currentIndex: 0,
            correctCount: 0,
            selectedChunks: []
        };

        const elements = {
            setup: document.getElementById('setup-screen'),
            practice: document.getElementById('practice-screen'),
            results: document.getElementById('results-screen'),
            lessonSelect: document.getElementById('lesson-select'),
            startBtn: document.getElementById('start-btn'),
            wordPool: document.getElementById('word-pool'),
            answerZone: document.getElementById('answer-zone'),
            progress: document.getElementById('progress-tag'),
            struct: document.getElementById('structure-hint'),
            example: document.getElementById('example-sentence'),
            lessonTitle: document.getElementById('lesson-title'),
            currentScore: document.getElementById('current-score-display'),
            finalScore: document.getElementById('final-score-text'),
            emoji: document.getElementById('score-emoji'),
            comment: document.getElementById('result-comment')
        };

        function init() {
            lessonsData.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.id;
                opt.textContent = l.title;
                elements.lessonSelect.appendChild(opt);
            });
        }

        elements.lessonSelect.onchange = () => {
            elements.startBtn.disabled = !elements.lessonSelect.value;
        };

        elements.startBtn.onclick = () => {
            const id = parseInt(elements.lessonSelect.value);
            const lesson = lessonsData.find(l => l.id === id);
            state.currentLesson = lesson;
            state.questions = [...lesson.items].sort(() => Math.random() - 0.5);
            state.currentIndex = 0;
            state.correctCount = 0;
            renderQuestion();
            showScreen('practice');
        };

        function renderQuestion() {
            const q = state.questions[state.currentIndex];
            state.selectedChunks = [];
            
            elements.lessonTitle.textContent = state.currentLesson.title;
            elements.progress.textContent = `é€²åº¦ ${state.currentIndex + 1} / ${state.questions.length}`;
            elements.struct.textContent = `çµæ§‹ï¼š${q.struct}`;
            elements.example.textContent = `ä¾‹å¥ï¼š${q.example || 'åƒè€ƒèª²æ–‡å…§å®¹'}`;
            elements.currentScore.textContent = Math.round((state.correctCount / state.questions.length) * 100);
            
            elements.wordPool.innerHTML = '';
            elements.answerZone.innerHTML = '';

            q.chunks.forEach(() => {
                const slot = document.createElement('div');
                slot.className = "answer-slot w-12 h-16 sm:w-16 sm:h-20 bg-white border-b-4 border-indigo-200 text-2xl font-black text-indigo-700";
                elements.answerZone.appendChild(slot);
            });

            const shuffled = [...q.chunks].sort(() => Math.random() - 0.5);
            shuffled.forEach(text => {
                const btn = document.createElement('button');
                btn.className = "word-btn bg-white border border-slate-200 px-6 py-3 rounded-2xl shadow-sm hover:border-indigo-400 hover:bg-indigo-50 transition-all font-bold text-slate-700 text-lg animate-pop-in";
                btn.textContent = text;
                btn.onclick = () => addToAnswer(text, btn);
                elements.wordPool.appendChild(btn);
            });
        }

        function addToAnswer(text, btn) {
            if (state.selectedChunks.length >= state.questions[state.currentIndex].chunks.length) return;

            const slotIndex = state.selectedChunks.length;
            const slots = elements.answerZone.querySelectorAll('.answer-slot');
            
            state.selectedChunks.push(text);
            btn.classList.add('opacity-0', 'pointer-events-none');

            slots[slotIndex].textContent = text;
            slots[slotIndex].classList.remove('border-indigo-200');
            slots[slotIndex].classList.add('border-indigo-600', 'animate-pop-in');
        }

        document.getElementById('clear-btn').onclick = () => renderQuestion();

        document.getElementById('check-btn').onclick = () => {
            if (state.selectedChunks.length === 0) return;

            const q = state.questions[state.currentIndex];
            const isCorrect = state.selectedChunks.join('') === q.chunks.join('');
            
            if (isCorrect) state.correctCount++;
            
            showToast(isCorrect, isCorrect ? "å¤ªæ£’äº†ï¼å®Œå…¨æ­£ç¢º âœ¨" : `æ­£ç¢ºç­”æ¡ˆï¼š${q.chunks.join('')}`);

            state.currentIndex++;
            setTimeout(() => {
                if (state.currentIndex < state.questions.length) {
                    renderQuestion();
                } else {
                    finish();
                }
            }, 1500);
        };

        function showToast(success, msg) {
            const toast = document.createElement('div');
            toast.className = `fixed top-10 left-1/2 transform -translate-x-1/2 px-10 py-5 rounded-3xl shadow-2xl font-black text-white z-50 animate-pop-in transition-all ${success ? 'bg-green-500' : 'bg-rose-500'}`;
            toast.innerHTML = `<div class="text-center text-lg">${msg}</div>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1400);
        }

        function finish() {
            const score = Math.round((state.correctCount / state.questions.length) * 100);
            elements.finalScore.textContent = score;

            if (score === 100) {
                elements.emoji.textContent = "ğŸ†";
                elements.comment.textContent = "å®Œç¾é”æˆï¼ä½ æ˜¯æ–‡å­—é‡çµ„å¤§å¸«ï¼";
            } else if (score >= 75) {
                elements.emoji.textContent = "ğŸŒŸ";
                elements.comment.textContent = "å¾ˆæ£’çš„è¡¨ç¾ï¼Œå†æ¥å†å²ï¼";
            } else {
                elements.emoji.textContent = "ğŸ’ª";
                elements.comment.textContent = "å†å¤šç·´ç¿’å¹¾æ¬¡ï¼Œä¸€å®šæœƒæ›´å¥½çš„ï¼";
            }

            showScreen('results');
        }

        function showScreen(name) {
            Object.values(elements).forEach(e => { if(e && e.id && e.id.endsWith('-screen')) e.hidden = true; });
            elements[name].hidden = false;
        }

        document.getElementById('home-btn').onclick = () => showScreen('setup');
        document.getElementById('retry-btn').onclick = () => elements.startBtn.click();

        init();
    </script>
</body>
</html>